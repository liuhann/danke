<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/vant/lib/index.css">
    <!-- 引入组件 -->
    <script src="https://unpkg.com/vant/lib/vant.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@1.4/lib/index.css">

    <!-- 引入组件 -->
    <script src="https://cdn.jsdelivr.net/npm/vant@1.4/lib/vant.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <style>
        .van-popup--right {
            left: 30px;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .el-table {
            overflow: auto;
        }
        .el-table .cell {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }

        .cover-image {
            width: 60px;
            height: 60px;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="grid-content bg-purple">
        <van-card v-for="(story, index) in tableData" :key="story._id"
                :tag="story.u?formateMill(story.u): ''"
                :desc="story.path"
                :title="story.title"
                :thumb="story.cover ? (CDN_IMG + '/' + story.cover + '.png@!w80') : ''"
                origin-price="10.00">
            <div slot="footer">
                {{story.label && story.label.join(' ')}}
                <van-button @click="showQueryBox(story)"  size="mini">查找</van-button>
                <van-button @click="playStory(story)" size="mini">播放</van-button>
                <van-button @click="removeStory(story)" size="mini">删除</van-button>
            </div>
        </van-card>
        <van-popup v-model="loading">
            加载中
        </van-popup>

        <van-popup v-model="showRelatedStory" position="right">
            <van-button @click="removeAllRelated">全部删除</van-button>
            <van-card v-for="(story, index) in relatedStories" :key="story._id"
                      :tag="story.u?formateMill(story.u): ''"
                      :desc="story.path"
                      :title="story.title"
                      :thumb="story.cover? ('/api/story/cover/480/480/' + story.cover + '.png') : ''">
                <div slot="footer">
                    <van-button @click="replaceStoryTitle(story)" size="mini">替换</van-button>
                    <van-button @click="relatedStories.splice(index, 1)" size="mini">排除</van-button>
                    <van-button @click="removeStory(story, true); relatedStories.splice(index, 1)" size="mini">删除</van-button>
                </div>
            </van-card>
        </van-popup>

        <van-dialog
                v-model="showSearchDialog"
                show-cancel-button
                confirm-button-text="按标题"
                cancel-button-text="按路径"
                @confirm="getSameTitle"
                @cancel="getSameAlbum">
            <van-field v-model="queryText"/>
        </van-dialog>
        <van-cell-group>
            <van-field
                    v-model="pageToGo">
                <van-button type="primary" @click="loadCurrentPage" size="small" slot="label">刷新</van-button>
                <van-button slot="button" size="small" type="primary" @click="gotoPage">GO</van-button>
                <van-button slot="button" size="small" type="primary" @click="deleteMarked">标记删除</van-button>
            </van-field>
        </van-cell-group>
        <van-pagination
                v-model="currentPage"
                @change="handleCurrentChange"
                :total-items="total"
                :items-per-page="10"/>
    </div>
</div>

<script type="module">
const app = new Vue({
    el: '#app',
    data() {
      return {
        CDN_IMG: 'http://imagek.cdn.bcebos.com',
        pageToGo: '',
        queryText: '',
        showRelatedStory: false,
        showSearchDialog: false,
        relatedStories: [],
        currentPage: 1,
        pageSize: 10,
        total: 0,
        tableData: [],
        loading: false,
        currentPlaying: null,
        dialogFormVisible: false,
        currentEditing: null
      }
    },

    mounted() {
      this.loadCurrentPage()
      setTimeout(() => {
        if (localStorage.getItem('page')) {
          this.currentPage = parseInt(localStorage.getItem('page'));
          this.loadCurrentPage();
        }
      }, 2000)
      //this.loadCurrentPage()
    },

    computed: {
      currentPlayingUrl() {
        if (this.currentPlaying) {
          return '/api/story/mp3/' + this.currentPlaying._id
        } else {
          return null
        }
      }
    },
    methods: {
      async gotoPage () {
        if (this.pageToGo) {
          this.currentPage = parseInt(this.pageToGo)
          this.loadCurrentPage();
        }
      },
      async loadCurrentPage () {
        this.loading = true;
        const result = await axios.get('/api/story/admin/list?skip=' + (this.currentPage - 1) * this.pageSize + '&limit=' + this.pageSize);
        this.loading = false;
        this.tableData = result.data.list
        this.total = result.data.total
      },

      async sizeChange (size) {
        this.pageSize = size;
        await this.loadCurrentPage();
      },

      async handleCurrentChange(page) {
        //this.currentPage = page
        localStorage.setItem('page', this.currentPage);
        await this.loadCurrentPage()
      },

      editStory (story) {
        this.dialogFormVisible = true;
        this.currentEditing = JSON.stringify(story, null, 2);
      },

      playStory (story) {
        this.currentPlaying = story
        if (this.howlStory) {
          this.howlStory.unload()
        }
        this.howlStory = new Howl({
          src: ['/api/story/mp3/' + story._id],
          html5: true,
          format: ['mp3']
        });
        this.howlStory.play();
        vant.Dialog.alert({
          title: '正在播放',
          message: '弹窗内容'
        }).then(() => {
          if (this.howlStory) {
            this.howlStory.unload()
          }
        });
      },

      pausePlay (story) {
        if (this.howlStory) {
          this.howlStory.unload()
        }
      },

      async removeStory (story, notRefresh) {
        const json = await axios.get('/api/story/delete/mark/' + story._id).json();
        //vant.Toast('删除成功');
        if (notRefresh) {
          for (let i = 0; i < this.tableData.length; i++) {
            if (this.tableData[i]._id === story._id) {
              this.tableData.splice(i, 1)
              break
            }
          }
          return
        } else {
          await this.loadCurrentPage()
        }
      },

      async deleteMarked () {
        let json = (await axios.get('/api/story/delete/one')).data
        while (json.path) {
          vant.Notify(json.path)
          await this.sleep(500)
          json = (await axios.get('/api/story/delete/one')).data
        }
      },

      async showQueryBox (story) {
        this.showSearchDialog = true
        this.currentEditing = story
        this.queryText = story.path
      },

      // 标题中包含
      async getSameTitle () {
        const sameNames = await ky.get(`/api/story/search?query=${this.queryText}&skip=0&limit=100`).json();
        if (sameNames.length > 1) {
          this.relatedStories = []
          for (let same of sameNames) {
            this.relatedStories.push(same)
          }
          this.showRelatedStory = true
        }
      },

      // 按路径搜索
      async getSameAlbum () {
        const paths = this.queryText.split('/')
        let path = paths[0] || paths[1]
        const sameNames = await ky.get(`/api/story/search/path?query=${path}/&skip=0&limit=50`).json();
        if (sameNames.length > 100) {
          this.relatedStories = sameNames.slice(0, 100)
        } else {
	        this.relatedStories = sameNames
        }
        this.showRelatedStory = true
      },

      async replaceStoryTitle (story) {
        await ky.post(`/api/story/props/${this.currentEditing._id}`, {json: {
            cover: story.cover
        }})
        this.showRelatedStory = false;
        this.loadCurrentPage();
      },

      formateMill (mill) {
        const d = new Date(mill);
        return d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
      },

      unRelatedThis(index) {
        this.relatedStories.splice(index, 1)
      },

      async removeAllRelated () {
        let story = this.relatedStories.pop()
        while (story) {
          await this.removeStory(story, true)
          story = this.relatedStories.pop()
        }
        this.showRelatedStory = false
        this.loadCurrentPage()
      },

      async sleep(mill) {
        return new Promise((resolve, reject) => {
          setTimeout(()=>{
            resolve()
          }, mill)
        })
      },

      async saveStory () {
        this.dialogFormVisible = false;
        try {
          let json = JSON.parse(this.currentEditing)
          await axios.post('http://118.25.210.124/api/story/update', {
            _id: json._id,
            title: json.title,
            desc: json.desc
          })
          this.loadCurrentPage();
        } catch (e) {

        }
      }
    }
})
</script>
</body>
</html>
